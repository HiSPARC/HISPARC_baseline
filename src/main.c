/*
 * ============================================================================
 *
 *       Filename:  running_average.c
 *
 *    Description:  This program implements a running average to still be able
 *                  to determine the average even if we have to few points
 *                  before the spike
 *
 *        Version:  2.0
 *        Created:  16-05-2014 15:06:53
 *       Compiler:  gcc
 *
 *         Author:  Jorian van Oostenbrugge
 *
 * ============================================================================
 */

#include <stdio.h>
#include <math.h>
#include <limits.h>
#include <stdbool.h>

#include "sequence.h"

#define STDEVLIMIT 3
#define MAXAVERAGE 245

// Hold the average
double gAverage;

// Declare functions
bool inRange(const int threshold, double value);
int calculateBaseline(int start, int array[], int size, const int threshold);
int findBaseline(int start, int end, int array[], const int size, const int threshold, const int width);

int
main (void)
{
    int nextArray[1952] = {198,201,199,200,200,202,200,200,201,
        200,199,201,198,202,199,202,198,204,208,238,312,427,519,
        539,524,489,449,413,386,365,357,347,
        328,317,299,285,274,279,271,258,251,243,239,245,238,237,
        228,223,218,217,214,214,214,214,211,216,214,214,211,213,
        212,211,205,209,204,208,209,216,213,214,208,208,208,207,
        204,209,205,207,202,203,204,215,218,217,212,215,208,206,
        206,205,201,203,201,204,201,202,199,200,198,203,199,203,
        202,203,200,203,198,205,199,203,197,202,199,202,199,204,
        199,203,203,206,203,203,207,218,215,212,207,211,205,205,
        202,202,200,203,200,201,200,205,199,202,199,201,200,200,
        200,202,199,203,200,197,200,202,201,201,200,203,199,201,
        199,201,199,198,200,204,199,202,199,201,200,201,198,201,
        200,201,198,204,199,198,197,199,196,199,198,201,197,203,
        198,200,197,202,197,198,198,198,197,201,197,198,198,200,
        196,199,199,200,196,198,198,200,196,201,195,200,197,200,
        198,197,197,201,197,199,197,199,195,199,197,199,197,200,
        198,203,197,199,198,203,197,201,197,200,198,201,195,198,
        195,199,196,202,199,198,199,201,198,201,199,200,198,199,
        198,200,199,199,195,202,197,199,197,201,196,201,199,201,
        197,197,197,200,195,201,197,200,200,201,211,232,236,232,
        222,221,209,209,202,206,201,204,201,202,200,201,197,200,
        198,200,199,202,197,201,198,202,197,201,199,202,198,202,
        199,201,199,201,198,201,197,200,198,199,197,202,197,203,
        199,199,198,201,197,199,198,201,197,203,197,202,198,201,
        198,199,198,200,198,203,198,201,197,199,196,200,197,200,
        198,201,197,199,196,199,198,203,198,200,198,199,199,201,
        196,200,197,198,199,202,196,201,199,203,198,201,197,198,
        199,201,198,201,198,199,197,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,253,253,253,253,253,253,253,253,253,253,
        253,253,253,253,198,200,198,202,197,199,198,199,198,201,
        197,200,199,203,196,199,199,200,197,199,196,200,198,199,
        198,201,197,201,199,202,196,200,196,203,197,199,198,203,
        199,201,199,201,197,202,197,200,198,201,197,201,199,201,
        196,200,198,200,201,202,197,201,199,202,200,202,195,199,
        200,200,198,201,197,199,198,202,197,202,198,200,197,201,
        199,201,198,202,197,199,197,199,196,201,197,202,199,201,
        198,201,197,201,197,201,198,199,198,199,195,200,196,202,
        199,199,197,199,199,202,198,200,197,201,197,199,197,201,
        197,201,196,199,198,201,199,204,199,201,199,199,198,199,
        198,200,196,201,197,203,199,201,197,199,198,202,196,204,
        198,198,201,201,196,198,197,200,199,201,200,199,197,200,
        198,201,198,197,198,203,197,200,198,201,198,198,197,201,
        198,196,198,199,198,201,198,202,194,201,197,199,197,197,
        200,201,199,203,199,201,198,201,196,203,200,200,197,198,
        198,200,198,200,199,200,197,200,197,198,198,200,198,202,
        199,199,200,200,197,199,198,200,198,203,199,201,200,200,
        197,200,199,201,200,203,197,198,198,200,198,200,196,200,
        197,202,195,200,198,200,199,200,199,202,199,202,197,199,
        197,200,199,199,199,200,198,200,199,201,198,198,199,202,
        198,201,196,200,197,201,199,202,197,202,198,202,197,201,
        199,200,197,202,197,199,200,203,197,201,197,201,199,203,
        197,201,198,201,199,202,197,203,198,201,196,201,197,201,
        198,200,198,200,198,200,199,201,199,200,196,201,197,201,
        200,200,198,200,199,200,199,201,197,201,197,201,196,202,
        197,202,198,201,198,201,198,201,198,201,197,201,197,199,
        199,200,197,201,197,199,198,198,197,199,197,200,200,199,
        195,200,198,200,198,203,199,201,197,200,197,201,200,201,
        199,202,197,198,200,202,196,197,198,200,198,200,198,200,
        200,200,198,201,197,200,199,202,198,203,199,201,196,200,
        200,199,198,200,198,200,198,200,199,202,197,203,199,201,
        197,201,199,202,199,199,197,202,199,200,198,201,199,203,
        198,200,200,200,197,202,197,201,198,201,198,200,197,202,
        198,203,198,202,200,201,198,200,199,200,196,200,199,200,
        198,202,198,199,197,200,198,200,198,201,199,202,199,201,
        199,200,199,203,197,201,196,202,197,201,198,200,198,201,
        197,201,196,200,198,201,196,202,199,200,198,202,199,201,
        197,202,199,201,198,199,200,200,198,203,198,201,199,202,
        201,200,198,201,197,201,196,201,199,201,200,202,199,200,
        199,201,198,201,200,201,198,199,198,201,199,202,198,199,
        199,202,200,201,199,202,199,202,198,201,200,201,199,202,
        197,202,198,201,199,200,199,201,198,201,199,201,199,200,
        198,202,199,201,199,201,197,199,200,202,198,202,200,201,
        198,203,200,200,198,201,198,199,199,200,198,203,199,203,
        199,201,197,200,199,204,197,204,198,199,200,202,198,201,
        200,201,201,203,199,199,200,201,198,202,199,200,197,202,
        199,201,199,201,197,200,199,203,198,200,199,200,199,203,
        198,201,198,201,198,203,199,200,199,200,199,202,198,202,
        199,202,198,203,198,199,198,200,197,200,200,201,199,203,
        197,202,198,199,200,201,197,201,199,203,200,202,198,202,
        199,203,198,203,197,201,200,193,199,202,200,206,197,203,
        200,202,201,202,199,202,198,201,199,201,198,202,199,204,
        199,201,200,200,197,203,199,200,198,202,199,200,200,202,
        199,203,198,201,200,201,197,203,198,201,198,201,200,202,
        200,203,199,200,200,201,198,201,200,202,196,198,198,200,
        198,200,197,204,198,201,198,202,198,201,199,200,199,203,
        197,200,198,202,198,201,198,203,199,203,198,199,200,203,
        199,200,200,202,199,201,198,201,198,203,197,199,200,202,
        199,201,197,201,197,201,199,199,199,202,198,200,197,202,
        198,201,199,203,198,205,198,201,198,201,199,202,196,200,
        198,202,199,200,199,202,198,201,198,200,197,201,200,201,
        199,202,199,202,198,201,198,201,197,201,199,201,198,200,
        198,201,198,200,198,202,199,200,198,202,198,201,199,202,
        198,201,199,203,199,203,198,200,198,202,200,202,196,202,
        197,201,197,202,197,202,199,200,198,203,201,201,196,201,
        199,200,198,200,198,201,199,202,197,200,197,200,198,200,
        198,201,198,201,200,203,199,201,198,202,199,201,198,201,
        200,200,198,200,199,202,199,201,198,202,200,201,198,202,
        198,203,198,201,199,201,197,201,199,201,199,203,197,199,
        201,202,199,202,197,201,199,200,198,201,199,201,197,201,
        198,202,198,203,196,202,200,201,199,199,198,203,198,202,
        198,201,198,200,199,202,197,202,199,199,199,202,198,201,
        198,201,199,202,199,201,199,200,201,199,200,198,199,203,
        197,203,200,199,198,201,198,201,199,201,197,203,197,200,
        198,202,197,201,200,200,199,201,198,202,198,202,197,202,
        199,203,200,204,197,201,199,202,196,201,197,204,199,203,
        198,203,198,200,200,200,197,202,198,203,197,199,200,202,
        199,200,199,202,198,199,199,202,199,201,196,199,197,200,
        198,201,197,200,198,201,196,199,199,202,198,203,198,201,
        198,199,200,203,197,203,197,201,199,201,200,203,198,203,
        199,201,198,201,197,201,199,202,199,200,198,201,199,202,
        198,200,195,200,198,199,199,199,199,202,198,201,197,201,
        200,202,195,203,199,201,199,203,197,202,198,201,199,202,
        198,200,199,200,197,202,198,200,198,201,199,203,198,203,
        197,201,197,200,199,201,198,200,201,202,200,200,198,199,
        197,202,199,200,200,198,200,203,197,201,198,202,197,204,
        198,201,199,201,199,200,197,203,196,202,197,200,198,198,
        198,199};
    
    int anArray[1934] = {208,238,312,427,519,539,524,489,449,413,386,365,357,347,
        328,317,299,285,274,279,271,258,251,243,239,245,238,237,
        228,223,218,217,214,214,214,214,211,216,214,214,211,213,
        212,211,205,209,204,208,209,216,213,214,208,208,208,207,
        204,209,205,207,202,203,204,215,218,217,212,215,208,206,
        206,205,201,203,201,204,201,202,199,200,198,203,199,203,
        202,203,200,203,198,205,199,203,197,202,199,202,199,204,
        199,203,203,206,203,203,207,218,215,212,207,211,205,205,
        202,202,200,203,200,201,200,205,199,202,199,201,200,200,
        200,202,199,203,200,197,200,202,201,201,200,203,199,201,
        199,201,199,198,200,204,199,202,199,201,200,201,198,201,
        200,201,198,204,199,198,197,199,196,199,198,201,197,203,
        198,200,197,202,197,198,198,198,197,201,197,198,198,200,
        196,199,199,200,196,198,198,200,196,201,195,200,197,200,
        198,197,197,201,197,199,197,199,195,199,197,199,197,200,
        198,203,197,199,198,203,197,201,197,200,198,201,195,198,
        195,199,196,202,199,198,199,201,198,201,199,200,198,199,
        198,200,199,199,195,202,197,199,197,201,196,201,199,201,
        197,197,197,200,195,201,197,200,200,201,211,232,236,232,
        222,221,209,209,202,206,201,204,201,202,200,201,197,200,
        198,200,199,202,197,201,198,202,197,201,199,202,198,202,
        199,201,199,201,198,201,197,200,198,199,197,202,197,203,
        199,199,198,201,197,199,198,201,197,203,197,202,198,201,
        198,199,198,200,198,203,198,201,197,199,196,200,197,200,
        198,201,197,199,196,199,198,203,198,200,198,199,199,201,
        196,200,197,198,199,202,196,201,199,203,198,201,197,198,
        199,201,198,201,198,199,197,203,197,200,199,202,202,206,
        201,204,200,200,199,203,197,201,200,204,199,201,198,201,
        198,203,197,201,198,200,197,203,198,201,198,200,197,198,
        197,202,197,201,196,198,197,202,199,201,199,198,196,200,
        199,202,197,202,195,198,197,202,199,202,199,201,198,199,
        198,199,197,202,197,199,196,201,196,198,200,202,199,203,
        198,200,199,200,198,199,198,202,197,201,197,202,198,200,
        198,201,198,200,199,202,198,200,198,201,200,201,197,201,
        198,200,198,201,199,200,197,201,197,199,197,202,198,202,
        197,203,199,201,196,203,199,201,195,201,197,200,199,199,
        196,200,197,203,197,199,198,201,198,201,197,200,198,197,
        196,201,197,201,197,200,199,201,196,203,197,199,200,200,
        196,200,199,203,198,200,198,202,199,201,197,200,198,202,
        199,201,198,199,197,202,199,199,197,202,198,202,198,199,
        196,200,199,200,198,200,197,202,197,200,198,200,198,199,
        198,203,197,200,197,200,197,202,198,200,196,201,200,201,
        200,201,199,201,197,199,198,202,197,200,197,202,197,202,
        198,199,198,200,198,199,197,203,197,203,197,198,197,202,
        197,200,196,199,197,201,195,201,198,202,197,201,196,200,
        197,200,198,202,199,199,198,201,196,199,197,202,199,203,
        199,200,198,201,198,203,197,200,198,199,197,199,198,202,
        198,200,198,199,199,201,198,200,197,200,197,199,196,202,
        199,199,199,200,196,198,198,201,197,202,196,200,198,202,
        199,203,197,197,199,201,197,200,199,201,196,199,198,200,
        199,203,202,201,199,200,198,198,198,200,199,199,197,201,
        198,200,199,200,198,200,198,202,197,199,198,199,198,201,
        197,200,199,203,196,199,199,200,197,199,196,200,198,199,
        198,201,197,201,199,202,196,200,196,203,197,199,198,203,
        199,201,199,201,197,202,197,200,198,201,197,201,199,201,
        196,200,198,200,201,202,197,201,199,202,200,202,195,199,
        200,200,198,201,197,199,198,202,197,202,198,200,197,201,
        199,201,198,202,197,199,197,199,196,201,197,202,199,201,
        198,201,197,201,197,201,198,199,198,199,195,200,196,202,
        199,199,197,199,199,202,198,200,197,201,197,199,197,201,
        197,201,196,199,198,201,199,204,199,201,199,199,198,199,
        198,200,196,201,197,203,199,201,197,199,198,202,196,204,
        198,198,201,201,196,198,197,200,199,201,200,199,197,200,
        198,201,198,197,198,203,197,200,198,201,198,198,197,201,
        198,196,198,199,198,201,198,202,194,201,197,199,197,197,
        200,201,199,203,199,201,198,201,196,203,200,200,197,198,
        198,200,198,200,199,200,197,200,197,198,198,200,198,202,
        199,199,200,200,197,199,198,200,198,203,199,201,200,200,
        197,200,199,201,200,203,197,198,198,200,198,200,196,200,
        197,202,195,200,198,200,199,200,199,202,199,202,197,199,
        197,200,199,199,199,200,198,200,199,201,198,198,199,202,
        198,201,196,200,197,201,199,202,197,202,198,202,197,201,
        199,200,197,202,197,199,200,203,197,201,197,201,199,203,
        197,201,198,201,199,202,197,203,198,201,196,201,197,201,
        198,200,198,200,198,200,199,201,199,200,196,201,197,201,
        200,200,198,200,199,200,199,201,197,201,197,201,196,202,
        197,202,198,201,198,201,198,201,198,201,197,201,197,199,
        199,200,197,201,197,199,198,198,197,199,197,200,200,199,
        195,200,198,200,198,203,199,201,197,200,197,201,200,201,
        199,202,197,198,200,202,196,197,198,200,198,200,198,200,
        200,200,198,201,197,200,199,202,198,203,199,201,196,200,
        200,199,198,200,198,200,198,200,199,202,197,203,199,201,
        197,201,199,202,199,199,197,202,199,200,198,201,199,203,
        198,200,200,200,197,202,197,201,198,201,198,200,197,202,
        198,203,198,202,200,201,198,200,199,200,196,200,199,200,
        198,202,198,199,197,200,198,200,198,201,199,202,199,201,
        199,200,199,203,197,201,196,202,197,201,198,200,198,201,
        197,201,196,200,198,201,196,202,199,200,198,202,199,201,
        197,202,199,201,198,199,200,200,198,203,198,201,199,202,
        201,200,198,201,197,201,196,201,199,201,200,202,199,200,
        199,201,198,201,200,201,198,199,198,201,199,202,198,199,
        199,202,200,201,199,202,199,202,198,201,200,201,199,202,
        197,202,198,201,199,200,199,201,198,201,199,201,199,200,
        198,202,199,201,199,201,197,199,200,202,198,202,200,201,
        198,203,200,200,198,201,198,199,199,200,198,203,199,203,
        199,201,197,200,199,204,197,204,198,199,200,202,198,201,
        200,201,201,203,199,199,200,201,198,202,199,200,197,202,
        199,201,199,201,197,200,199,203,198,200,199,200,199,203,
        198,201,198,201,198,203,199,200,199,200,199,202,198,202,
        199,202,198,203,198,199,198,200,197,200,200,201,199,203,
        197,202,198,199,200,201,197,201,199,203,200,202,198,202,
        199,203,198,203,197,201,200,193,199,202,200,206,197,203,
        200,202,201,202,199,202,198,201,199,201,198,202,199,204,
        199,201,200,200,197,203,199,200,198,202,199,200,200,202,
        199,203,198,201,200,201,197,203,198,201,198,201,200,202,
        200,203,199,200,200,201,198,201,200,202,196,198,198,200,
        198,200,197,204,198,201,198,202,198,201,199,200,199,203,
        197,200,198,202,198,201,198,203,199,203,198,199,200,203,
        199,200,200,202,199,201,198,201,198,203,197,199,200,202,
        199,201,197,201,197,201,199,199,199,202,198,200,197,202,
        198,201,199,203,198,205,198,201,198,201,199,202,196,200,
        198,202,199,200,199,202,198,201,198,200,197,201,200,201,
        199,202,199,202,198,201,198,201,197,201,199,201,198,200,
        198,201,198,200,198,202,199,200,198,202,198,201,199,202,
        198,201,199,203,199,203,198,200,198,202,200,202,196,202,
        197,201,197,202,197,202,199,200,198,203,201,201,196,201,
        199,200,198,200,198,201,199,202,197,200,197,200,198,200,
        198,201,198,201,200,203,199,201,198,202,199,201,198,201,
        200,200,198,200,199,202,199,201,198,202,200,201,198,202,
        198,203,198,201,199,201,197,201,199,201,199,203,197,199,
        201,202,199,202,197,201,199,200,198,201,199,201,197,201,
        198,202,198,203,196,202,200,201,199,199,198,203,198,202,
        198,201,198,200,199,202,197,202,199,199,199,202,198,201,
        198,201,199,202,199,201,199,200,201,199,200,198,199,203,
        197,203,200,199,198,201,198,201,199,201,197,203,197,200,
        198,202,197,201,200,200,199,201,198,202,198,202,197,202,
        199,203,200,204,197,201,199,202,196,201,197,204,199,203,
        198,203,198,200,200,200,197,202,198,203,197,199,200,202,
        199,200,199,202,198,199,199,202,199,201,196,199,197,200,
        198,201,197,200,198,201,196,199,199,202,198,203,198,201,
        198,199,200,203,197,203,197,201,199,201,200,203,198,203,
        199,201,198,201,197,201,199,202,199,200,198,201,199,202,
        198,200,195,200,198,199,199,199,199,202,198,201,197,201,
        200,202,195,203,199,201,199,203,197,202,198,201,199,202,
        198,200,199,200,197,202,198,200,198,201,199,203,198,203,
        197,201,197,200,199,201,198,200,201,202,200,200,198,199,
        197,202,199,200,200,198,200,203,197,201,198,202,197,204,
        198,201,199,201,199,200,197,203,196,202,197,200,198,198,
        198,199};
    
    findBaseline(0, 100, anArray, 1934, 10, 100);
    printf("Found average = %.7f\n", gAverage);
}

int
findBaseline(int start, int end, int array[], const int size, const int threshold, const int width)
{
    // Error checking
    if (size < 0 || width < 0)
        return (-5000);
    
    // Try to calculate the baseline starting from start
    int startOfError = calculateBaseline(start, array, size, threshold);
    
    // Found baseline so quit else everything below -1 signifies error so return error
    if (startOfError == -1)
        return 0;
    else if (startOfError < -1)
        return startOfError;
    
    // No baseline yet, so find next starting position, start from failing
    // point of calculateBaseline
    int newStart = compareSequences(startOfError, (startOfError + width), array, size, width);
    printf("start = %i\n", newStart);
    
    // No next starting point...
    if (newStart == INT_MAX)
        return -999;

    // No problems so far, so update the end and try again
    int newEnd = newStart + width;
    
    return (findBaseline(newStart, newEnd, array, size, threshold, width));
}

/*
 * This function tries to determine the baseline from a given array.
 * If we do not have sufficient points before we reach the spike, the
 * function returns the element were if failed else if we do find 
 * enough points, we set a pointer to the value of the calculated 
 * baseline and return -1 because that can never be an element of an
 * array
 */
int
calculateBaseline(int start, int array[], int size, const int threshold)
{
    // Declare variables
    int i;
    double sum = 0;
    double average;
    double differenceFromAverage;
    double differenceInPoints;
    
    // Make sure it is likely we have more than enough points to calculate the baseline
    if (start < 0)
        return (-5001);
    else if (size < 50)
        return (-5002);
    
    // Itereate over each element in the array
    // Start with second element (start + 1) because we need to compare it to a previous element
    // We want as much elements as possible so we set size of array as maximum We use the +1 to
    // account for the fact that we take the average until i - 1, so we do end up at end of array
    for (i = (start + 1); i < (size + 1); i++)
    {
        // Calculate the average up to i.e. not including the current element
		// Should go before threshold check, otherwise last element is not
		// included in baseline
        sum += array[i - 1];
        average = sum / (i - start);
        
        // Determine difference between average and current point
        // Should go before difference between current point and previous point
        // because this is more likely to fail first
		differenceFromAverage = (double) array[i] - average;
        
		// Deviaton from average should fall within threshold
		if (!inRange(threshold, differenceFromAverage))
			break;
        
        // Determine difference between current and previous point
		differenceInPoints = (double) array[i] - array[i - 1];
        
		// Make sure separate points are within the double threshold
		if (!inRange((threshold * 2), differenceInPoints))
			break;
    }
    
    // IF we have enough points to calculate the baseline set pointer to
    // baseline value and return (-1) else return element were calculating
    // failed
    if ((i - start) >= 50)
    {
        printf("end = %i\n", i);
        gAverage = average;
        return (-1);
    }
    else
        return (i);
}

/*
 * Check if a value lies within the absolute value of the supplied threshold
 * i.e. more than the negative value of the threshold and less than the
 * positive value of the threshold
 */
bool
inRange(const int threshold, double value)
{
	if (threshold >= value && value >= (-threshold))
		return true;
	else
		return false;
}